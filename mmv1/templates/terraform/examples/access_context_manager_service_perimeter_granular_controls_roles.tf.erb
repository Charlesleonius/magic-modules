resource "google_access_context_manager_access_policy" "access-policy" {
  parent = "organizations/123456789"
  title  = "Policy with Granular Controls Group Support"
}

resource "google_access_context_manager_service_perimeter" "test-access" {
  parent         = "accessPolicies/${google_access_context_manager_access_policy.test-access.name}"
  name           = "accessPolicies/${google_access_context_manager_access_policy.test-access.name}/servicePerimeters/%s"
  title          = "%s"
  perimeter_type = "PERIMETER_TYPE_REGULAR"
  status {
      restricted_services = ["bigquery.googleapis.com", "storage.googleapis.com"]
      vpc_accessible_services {
          enable_restriction = true
          allowed_services   = ["bigquery.googleapis.com", "storage.googleapis.com"]
      }
      ingress_policies {
          ingress_from {
              sources {
                  access_level = google_access_context_manager_access_level.test-access.name
              }
              identities = ["user:admin@google.com"]
          }
          ingress_to {
            resources = [ "*" ]
            roles = ["roles/bigquery.admin", "organizations/123456789/roles/custom_admin_role"]
          }
      }
      egress_policies {
          egress_from {
              identities = ["user:admin@google.com"]
          }
          egress_to {
              resources = [ "*" ]
              roles = ["roles/bigquery.admin", "organizations/123456789/roles/custom_admin_role"]
         }
      }
   }
}
